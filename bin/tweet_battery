#!/usr/bin/env perl
use 5.010;
use utf8;
use strict;
use warnings;
use Net::Twitter;

require $ENV{HOME}."/bin/tweet-base";

my $battery_info = parse_acpi();
die "배터리 정보를 가져올 수 없었습니다!" unless $battery_info;

my $status = sprintf("현재 노트북 배터리는 %d%% 이며, ", $battery_info->{battery});

if ($battery_info->{status} eq "Full") {
    $status .= "완전히 충전되었습니다.";
} elsif ($battery_info->{status} eq "Charging") {
    $status .= sprintf("충전 중입니다. 완전히 충전될 때까지 %s 남았습니다.", $battery_info->{remaining});
} else {
    unless (@ARGV) {
        $status .= sprintf("앞으로 %s 동안 사용할 수 있습니다.", $battery_info->{remaining});
    } elsif ($ARGV[0] eq "-w") {
        $status .= "배터리가 부족하여 30초 후 시스템이 종료됩니다. 얼른 작업을 정리해 주세요.";    
    }
}

$status .= sprintf(' #%s @_KAWAll', $battery_info->{status}); 

post($status);

sub parse_acpi {
    my $acpi = shift;
    $acpi = `acpi` unless $acpi;

    if ($acpi =~ m/Battery \d: (?<status>.+), (?<battery>\d{1,3})\%, (?<remaining>.+?) \w+/) {
        return {
            status    => $+{status},
            battery   => $+{battery},
            remaining => $+{remaining},
        } 
    } else {
        return undef;
    }
 }
